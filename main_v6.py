# -*- coding: utf-8 -*-
"""main_v6.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1POOwXUJfCtoLLXsqCVeTOaOcoutumX8Y
"""

!git clone https://wayo116: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@github.com/wayo116/2306_l6.git
#!pip install umap-learn
import os
import csv
import time

os.chdir('/content/2306_l6')

from datalists import dlists
from Utility.inner_outer import combi
from Dell6_v2 import Dell6
from Utility.LightgbmPack import LightgbmPack
from Utility.datalists_check import datalists_check
from Utility.per_hyouji import per_hyouji

start = time.time()

kekka_matomes = []

kaisai = 10
if kaisai == -1:
    st = -1
    ed = 0
elif kaisai == 0:
    st = 0
    ed = 1
elif kaisai > 0:
    st = 1
    ed = kaisai + 1

dlists_shoki = dlists

for kaisai in range(st,ed):
    print("\nkaisai",kaisai)
    dlists = dlists_shoki
    if kaisai == -1:
        #本番
        #最新結果がgitjubに登録済の時
        saisinkekka_list=[99,99,99,99,99,99]
        dlists = dlists_shoki
    elif kaisai == 0:
        #最新結果がcolabにはあるが、gitjubには未登録の時
        saisinkekka_list=[1,8,23,30,36,41]
        dlists = dlists_shoki
    elif kaisai > 0:
        saisinkekka_list = dlists_shoki[kaisai-1]
        dlists = dlists_shoki[kaisai:]
    print("saisinkekka_list",saisinkekka_list)
    print("dlists",dlists[:5])

    bunkatu=5

    print('\n----vol 1----')
    # 初期値
    dlists_end = 600
    predictions_all = []
    lgbm_obj = LightgbmPack()
    params = {"dataset_params":{"study_range_start":-0.01,
                                "study_range_end":0.01,
                                "study_nmasi":3,
                                "test_range_start":-3,
                                "test_range_end":3,
                                "test_nmasi":10,
                                "bunseki_hani":8,
                                "flat_hani":4,
                                "test_dlists_hani":[0,1]},
                "lgbm_params":{"lgbm_model":"light_gbm_v2",
                                'num_leaves':256,
                                'learning_rate':0.05,
                                "n_estimators":32,
                                "max_depth":-1,
                                "random_seed":42,
                                "cv":3,}}

    # 処理
    predictions_all = lgbm_obj.lightgbmpack(kaisai, saisinkekka_list, dlists, dlists_end, **params)

    # 表示
    print("saisinkekka_list",saisinkekka_list)
    predictions_all = sorted(list(map(int, set(predictions_all))))
    print("predictions_all",predictions_all)
    per_hyouji(saisinkekka_list,predictions_all)


    print('\n----vol 2----')
    delall = 0

    # 初期値
    predictions_delall = []

    if delall:
        # 初期値
        predictions_delall = []

        # 処理
        predictions_delall = datalists_check(dlists,len(dlists),2)

        # 表示
        print("saisinkekka_list",saisinkekka_list)
        predictions_delall = sorted(list(map(int, set(predictions_delall))))
        print("predictions_delall",predictions_delall)
        per_hyouji(saisinkekka_list,predictions_delall)


    print('\n----vol 1 2----')
    # 初期値
    predictions_unique = []

    # 処理
    predictions_unique = [item for item in predictions_all if item not in predictions_delall]

    # 表示
    print("saisinkekka_list",saisinkekka_list)
    predictions_unique = sorted(list(map(int, set(predictions_unique))))
    print("predictions_unique",predictions_unique)
    wariai, percent = per_hyouji(saisinkekka_list,predictions_unique)

    pred_dlists = combi(predictions_unique,6)

    #shori2は、pred_dlistsには組合せリストを入れる
    outlist, kankin =Dell6(dlists, pred_dlists, saisinkekka_list, bunkatu).shori2()
    #outlists.extend(outlist)
    #print('outlist',outlist)

    kekka_matomes.append([kaisai, wariai, percent, kankin])

goukei = 0
for kekka_matome in kekka_matomes:
    goukei = goukei + kekka_matome[3]
    print(kekka_matome)
print("goukei",goukei)

print("処理時間",time.time() - start)

from google.colab import drive
drive.mount('/content/drive')